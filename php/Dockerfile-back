FROM php:8.2-fpm

# 安裝系統依賴 + PHP 擴充 + LibreOffice + 中文字型
# -----------------------------------------------------------
# [新增] libreoffice-writer: 核心轉檔軟體
# [新增] default-jre-headless: LibreOffice 依賴的 Java 環境 (無 GUI 版)
# [新增] fonts-noto-cjk: Google Noto CJK 字型 (解決中文亂碼/方塊字問題)
# [新增] libzip-dev: Word/Excel/ZipArchive 依賴
RUN apt-get update && apt-get install -y \
    libfreetype6-dev \
    libjpeg62-turbo-dev \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    libzip-dev \
    zip \
    unzip \
    git \
    curl \
    autoconf \
    g++ \
    make \
    libreoffice-writer \
    default-jre-headless \
    fonts-noto-cjk \
    fonts-noto-cjk-extra \
 && pecl install redis \
 && docker-php-ext-enable redis \
 && docker-php-ext-configure gd --with-freetype --with-jpeg \
 && docker-php-ext-install pdo pdo_mysql mbstring exif pcntl bcmath gd zip \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

# 2. Install Composer
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

# 3. 建立非 root 使用者 (配合 PUID/PGID)
ARG PUID=1000
ARG PGID=1000

# -m 參數很重要，它會建立 /home/appuser，LibreOffice 需要有寫入權限的 Home 目錄來存暫存檔
RUN groupadd -g ${PGID} appgroup \
 && useradd -u ${PUID} -g appgroup -m appuser

# 設定工作目錄
WORKDIR /var/www/html

# 複製 PHP 設定
COPY php.ini /usr/local/etc/php/conf.d/zz-custom.ini

# 確保目錄權限
RUN mkdir -p /var/www/html \
 && chown -R appuser:appgroup /var/www

# 切換使用者
USER appuser

EXPOSE 9000
CMD ["php-fpm"]